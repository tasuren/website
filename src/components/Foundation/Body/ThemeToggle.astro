---
import FloatButton from "@components/FloatButton.astro";
---
<style is:global>
  #theme-toggle {
    font-size: 20px;
    /* ä¸€èª¿æ•´ */
    right: 10%; bottom: 10%;
    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒ¼ãƒã®ç„¡åŠ¹åŒ–ã€‚ */
    background: none;
    border: none;
    outline: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }
</style>
<script>
  // å®Ÿé¨“ãŒã§ãã‚‹ã‚ˆã†ã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’æ‹¡å¼µã€‚
  interface MyWindow extends Window {
      resetTheme(): void;
  };
  declare var window: MyWindow;


  // è‰²ã€…æº–å‚™ã€‚
  type Theme = "dark" | "light";
  type Setting = Theme | "auto";
  const EMOJIS: {[theme: string]: string} = {
    auto: "ğŸŒ“", dark: "ğŸŒ™", light: "â˜€ï¸"
  };


  // highlight.jsã®ã‚¹ã‚¿ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šæ‰±ã„ã®ãŸã‚ã®APIã€‚
  let styleLinks = null;
  const updateHighlightStyle = (theme: Theme) => {
    if (styleLinks == null) {
      let element = document.getElementById("highlight-style-links");
      if (element) styleLinks = JSON.parse(element.innerText);
      else styleLinks = {};
    };
    if (theme in styleLinks) {
      var link = document.getElementById("highlight-style") as HTMLLinkElement | null;
      if (!link) {
        link = document.createElement("link");
        link.rel = "stylesheet";
        link.id = "highlight-style";
        document.head.append(link);
      };
      link.href = styleLinks[theme];
      link.setAttribute("data-theme", theme);
    };
  };


  // è¨­å®šå¤‰æ›´ç”¨ã®APIã€‚
  const get = (): Setting => localStorage.getItem("theme") as Setting || "auto";
  const set = (theme: Setting) => localStorage.setItem("theme", theme);
  const reset = () => localStorage.removeItem("theme");
  window.resetTheme = reset;

  let toggleButton = document.getElementById("theme-toggle");
  const updateEmoji = (setting: Setting) =>
    toggleButton.innerText = EMOJIS[setting];
  const effect = (
    theme: Theme, setting?: Setting,
    enableUpdateHighlightStyle: boolean = true
  ) => {
    document.documentElement.setAttribute("data-theme", theme);
    if (setting) updateEmoji(setting);
    if (enableUpdateHighlightStyle) updateHighlightStyle(theme);
  };
  const detectTheme = (setting: Setting): Theme => {
    if (setting == "auto")
      return window.matchMedia
        ('(prefers-color-scheme: dark)')
          .matches ? "dark" : "light";
    else return setting;
  };


  // å‰ã®è¨­å®šã‚’å¼•ãç¶™ãã€‚
  let initialTimeSetting = get();
  // åˆæœŸåŒ–ã™ã‚‹ã€‚
  let initialTimeTheme = detectTheme(initialTimeSetting);
  if (initialTimeTheme == "light")
    effect("light", initialTimeSetting, false);
  else if (initialTimeSetting == "auto")
    updateEmoji(initialTimeSetting);
  updateHighlightStyle(initialTimeTheme);


  // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’ç”¨æ„ã™ã‚‹ã€‚
  toggleButton.addEventListener("click", () => {
    // è¨­å®šã‚’èª­ã¿è¾¼ã¿ã€æ¬¡ã®ãƒ†ãƒ¼ãƒã‚’èª¿ã¹ã‚‹ã€‚
    var setting = get();
    if (setting == "auto") setting = "dark";
    else if (setting == "dark") setting = "light";
    else setting = "auto";
    // ãƒ†ãƒ¼ãƒã®è¨­å®šã‚’æ›´æ–°ã™ã‚‹ã€‚
    set(setting);
    // ãƒ†ãƒ¼ãƒã‚’é©ç”¨ã™ã‚‹ã€‚
    effect(detectTheme(setting), setting);
  });
</script>
<FloatButton id="theme-toggle" text="ğŸŒ™" />